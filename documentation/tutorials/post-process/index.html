<!DOCTYPE html>
<html lang="en">

	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

		<title>Post Processing</title>

		<meta name="description" content="HaxePunk is a 2d game engine written in Haxe for cross-platform deployment.">
		<meta name="author" content="HaxePunk.com">
		<meta name="HandheldFriendly" content="True">
		<meta name="MobileOptimized" content="320">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">

		<link rel="shortcut icon" type="image/png" href="http://haxepunk.com/img/favicon.png">

		<link rel="stylesheet" type="text/css" href="http://haxepunk.com/css/ink.css">
		<link rel="stylesheet" type="text/css" href="http://haxepunk.com/css/syntax.css">
		<link rel="stylesheet" type="text/css" href="http://haxepunk.com/css/custom.css">

		<script>
		(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
		(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
		m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
		})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

		ga('create', 'UA-5069201-6', 'haxepunk.com');
		ga('send', 'pageview');
		</script>
	</head>

	<body>
		<div class="top-menu">
			<a href="http://haxepunk.com/" class="logo">
				<image src="http://haxepunk.com/img/HaxePunk.svg" width="300" height="75" alt="HaxePunk" />
			</a>
			<nav class="ink-navigation">
				<ul class="menu horizontal orange">
					<li class="">
						<a href="http://haxepunk.com/">Home</a>
					</li>
					<li class="">
						<a href="http://haxepunk.com/features/">Features</a>
					</li>
					<li class="">
						<a href="http://haxepunk.com/demos/">Demos</a>
					</li>
					<li class="active">
						<a href="http://haxepunk.com/documentation/">Documentation</a>
					</li>
					<li class="">
						<a href="http://haxepunk.com/games/">Games</a>
					</li>
					<li>
						<a href="http://forum.haxepunk.com/">Forum</a>
					</li>
				</ul>
			</nav>
		</div>

		<div class="github">
			<a href="https://github.com/HaxePunk/HaxePunk">Fork me on GitHub</a>
		</div>

<div class="ink-grid vspace mainpoints">
	<h1>Post Processing using GLSL</h1>

<p>Fullscreen post processing effects are possible in HaxePunk with two additional classes and some tweaking to your main class. A full example is on GitHub under the <a href="https://github.com/HaxePunk/post-process">post-process project</a>.</p>

<p><img src="/documentation/tutorials/images/shaders.jpg" alt="Post processing shaders"></p>

<p>First grab the classes <a href="https://raw.github.com/HaxePunk/post-process/master/src/PostProcess.hx">PostProcess.hx</a> and <a href="https://raw.github.com/HaxePunk/post-process/master/src/Shader.hx">Shader.hx</a> from the GitHub project. Put these in the root of your project folder. Now we are going to add a few overrides to the main class in your project, normally called <em>Main.hx</em>.</p>

<h3>Main.hx</h3>
<div class="highlight"><pre><code class="language-haxe" data-lang="haxe"><span class="kn">import</span> <span class="nn">com</span><span class="p">.</span><span class="nn">haxepunk</span><span class="p">.</span><span class="nn">Engine</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com</span><span class="p">.</span><span class="nn">haxepunk</span><span class="p">.</span><span class="nn">HXP</span><span class="p">;</span>

<span class="kd">class</span> <span class="n">Main</span> <span class="kd">extends</span> <span class="n">Engine</span>
<span class="p">{</span>

    <span class="kd">override</span> <span class="kd">public</span> <span class="kd">function</span> <span class="nf">init</span><span class="p">()</span>
    <span class="p">{</span>
<span class="cp">#if debug</span>
        <span class="n">HXP</span><span class="p">.</span><span class="n">console</span><span class="p">.</span><span class="n">enable</span><span class="p">();</span>
<span class="cp">#end</span>
        <span class="n">HXP</span><span class="p">.</span><span class="n">scene</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MainScene</span><span class="p">();</span>

        <span class="c1">// Change to the glsl file you want to use</span>
        <span class="n">post</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PostProcess</span><span class="p">(</span><span class="s2">&quot;shaders/invert.frag&quot;</span><span class="p">);</span>
        <span class="n">post</span><span class="p">.</span><span class="n">enable</span><span class="p">();</span> <span class="c1">// should be after HXP.console.enable</span>
    <span class="p">}</span>

    <span class="kd">override</span> <span class="kd">public</span> <span class="kd">function</span> <span class="nf">resize</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">super</span><span class="p">.</span><span class="n">resize</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">post</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="n">post</span><span class="p">.</span><span class="n">rebuild</span><span class="p">();</span> <span class="c1">// must be after super.resize</span>
    <span class="p">}</span>

    <span class="kd">override</span> <span class="kd">public</span> <span class="kd">function</span> <span class="nf">render</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">post</span><span class="p">.</span><span class="n">capture</span><span class="p">();</span> <span class="c1">// must be before super.render</span>
        <span class="n">super</span><span class="p">.</span><span class="n">render</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="kd">private</span> <span class="kd">var</span> post<span class="p">:</span><span class="n">PostProcess</span><span class="p">;</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">function</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span> <span class="k">new</span> <span class="n">Main</span><span class="p">();</span> <span class="p">}</span>

<span class="p">}</span>
</code></pre></div>
<p>Before we run anything we need to add a shaders folder to assets and hook it into the <code>project.xml</code> file. Add the following line inside your <code>project.xml</code> after the other <code>&lt;assets /&gt;</code> lines. This will let you import anything with a <code>.vert</code> or <code>.frag</code> extension.</p>
<div class="highlight"><pre><code class="language-xml" data-lang="xml">    <span class="nt">&lt;assets</span> <span class="na">path=</span><span class="s">&quot;assets/shaders&quot;</span> <span class="na">rename=</span><span class="s">&quot;shaders&quot;</span> <span class="na">include=</span><span class="s">&quot;*.vert|*.frag&quot;</span> <span class="nt">/&gt;</span>
</code></pre></div>
<p>Now comes the really fun part, shaders. You&#39;ll notice in the GitHub project there are a bunch of example shaders you can use right off the bat. A few of them require some additional effort to get working but let&#39;s start with the <code>invert.frag</code> shader since that&#39;s what we added above. Drop the following code in a file named <code>assets/shaders/invert.frag</code> and test it using neko or cpp (Flash doesn&#39;t support glsl).</p>

<h3>assets/shaders/invert.frag</h3>
<div class="highlight"><pre><code class="language-glsl" data-lang="glsl"><span class="cp">#version 120</span>

<span class="cp">#ifdef GL_ES</span>
    <span class="k">precision</span> <span class="k">mediump</span> <span class="k">float</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="k">varying</span> <span class="k">vec2</span> <span class="n">vTexCoord</span><span class="p">;</span>
<span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">uImage0</span><span class="p">;</span>

<span class="k">void</span> <span class="n">main</span><span class="p">(</span><span class="k">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">vec4</span> <span class="n">color</span> <span class="o">=</span> <span class="n">texture2D</span><span class="p">(</span><span class="n">uImage0</span><span class="p">,</span> <span class="n">vTexCoord</span><span class="p">);</span>
    <span class="n">gl_FragColor</span> <span class="o">=</span> <span class="k">vec4</span><span class="p">(</span><span class="k">vec3</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">-</span> <span class="n">color</span><span class="p">.</span><span class="n">rgb</span><span class="p">,</span> <span class="n">color</span><span class="p">.</span><span class="n">a</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>So we can see that the first line specifies the glsl version we want to use, <code>version 120</code> is default for OpenGL ES which is what OpenFL uses. The <code>#ifdef GL_ES</code> lines are to specify the precision on mobile devices. We could set it to <code>highp</code> but <code>mediump</code> seems to work well in most cases. Then we have the uniform and varying lines which define variables passed to the shader from the <code>PostProcess</code> class. Finally the main function is defined and we are simply inverting the color values and retaining alpha.</p>

<p>What if you want to set your own uniform values though? You&#39;re in luck because PostProcess has a way to define them. At the moment it only supports single float values though so you may have to get creative. Take for example the <code>scanline.frag</code> shader. It includes a scale uniform that isn&#39;t defined by <code>PostProcess</code> and initially set to <code>1.0</code>.</p>

<h3>assets/shaders/scanline.frag</h3>
<div class="highlight"><pre><code class="language-glsl" data-lang="glsl"><span class="cp">#version 120</span>

<span class="cp">#ifdef GL_ES</span>
    <span class="k">precision</span> <span class="k">mediump</span> <span class="k">float</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="k">varying</span> <span class="k">vec2</span> <span class="n">vTexCoord</span><span class="p">;</span>
<span class="k">uniform</span> <span class="k">vec2</span> <span class="n">uResolution</span><span class="p">;</span>
<span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">uImage0</span><span class="p">;</span>

<span class="k">uniform</span> <span class="k">float</span> <span class="n">scale</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">;</span>

<span class="k">void</span> <span class="n">main</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">mod</span><span class="p">(</span><span class="n">floor</span><span class="p">(</span><span class="n">vTexCoord</span><span class="p">.</span><span class="n">y</span> <span class="o">*</span> <span class="n">uResolution</span><span class="p">.</span><span class="n">y</span> <span class="o">/</span> <span class="n">scale</span><span class="p">),</span> <span class="mf">2.0</span><span class="p">)</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">)</span>
        <span class="n">gl_FragColor</span> <span class="o">=</span> <span class="k">vec4</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">);</span>
    <span class="k">else</span>
        <span class="n">gl_FragColor</span> <span class="o">=</span> <span class="n">texture2D</span><span class="p">(</span><span class="n">uImage0</span><span class="p">,</span> <span class="n">vTexCoord</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>To set the uniform&#39;s value from Haxe you can use the <code>PostProcess</code> object in your <code>Main.hx</code> file.</p>
<div class="highlight"><pre><code class="language-haxe" data-lang="haxe"><span class="n">post</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PostProcess</span><span class="p">(</span><span class="s2">&quot;shaders/scanline.frag&quot;</span><span class="p">);</span>
<span class="n">post</span><span class="p">.</span><span class="n">setUniform</span><span class="p">(</span><span class="s2">&quot;scale&quot;</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">);</span>
</code></pre></div>
<h2>Multi-pass techniques</h2>

<p>Now you may be thinking, what if I want to have multiple shaders? The answer is more <code>PostProcess</code> objects! You can chain them together by using the framebuffers created on each pass. Here&#39;s how to do it with the two shaders we&#39;ve created.</p>
<div class="highlight"><pre><code class="language-haxe" data-lang="haxe"><span class="kn">import</span> <span class="nn">com</span><span class="p">.</span><span class="nn">haxepunk</span><span class="p">.</span><span class="nn">Engine</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com</span><span class="p">.</span><span class="nn">haxepunk</span><span class="p">.</span><span class="nn">HXP</span><span class="p">;</span>

<span class="kd">class</span> <span class="n">Main</span> <span class="kd">extends</span> <span class="n">Engine</span>
<span class="p">{</span>

    <span class="kd">override</span> <span class="kd">public</span> <span class="kd">function</span> <span class="nf">init</span><span class="p">()</span>
    <span class="p">{</span>
<span class="cp">#if debug</span>
        <span class="n">HXP</span><span class="p">.</span><span class="n">console</span><span class="p">.</span><span class="n">enable</span><span class="p">();</span>
<span class="cp">#end</span>
        <span class="n">HXP</span><span class="p">.</span><span class="n">scene</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MainScene</span><span class="p">();</span>

        <span class="n">invert</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PostProcess</span><span class="p">(</span><span class="s2">&quot;shaders/invert.frag&quot;</span><span class="p">);</span>
        <span class="n">scanline</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PostProcess</span><span class="p">(</span><span class="s2">&quot;shaders/scanline.frag&quot;</span><span class="p">);</span>
        <span class="n">scanline</span><span class="p">.</span><span class="n">setUniform</span><span class="p">(</span><span class="s2">&quot;scale&quot;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">);</span>

        <span class="n">invert</span><span class="p">.</span><span class="n">enable</span><span class="p">(</span><span class="n">scanline</span><span class="p">);</span> <span class="c1">// pass scanline to invert as the &quot;next&quot; shader</span>
        <span class="n">scanline</span><span class="p">.</span><span class="n">enable</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="kd">override</span> <span class="kd">public</span> <span class="kd">function</span> <span class="nf">resize</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">super</span><span class="p">.</span><span class="n">resize</span><span class="p">();</span>
        <span class="c1">// must rebuild all framebuffers</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">scanline</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="n">scanline</span><span class="p">.</span><span class="n">rebuild</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">invert</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="n">invert</span><span class="p">.</span><span class="n">rebuild</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="kd">override</span> <span class="kd">public</span> <span class="kd">function</span> <span class="nf">render</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">// only capture on the first shader, in this case invert</span>
        <span class="n">invert</span><span class="p">.</span><span class="n">capture</span><span class="p">();</span>
        <span class="n">super</span><span class="p">.</span><span class="n">render</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="kd">private</span> <span class="kd">var</span> invert<span class="p">:</span><span class="n">PostProcess</span><span class="p">;</span>
    <span class="kd">private</span> <span class="kd">var</span> scanline<span class="p">:</span><span class="n">PostProcess</span><span class="p">;</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">function</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span> <span class="k">new</span> <span class="n">Main</span><span class="p">();</span> <span class="p">}</span>

<span class="p">}</span>
</code></pre></div>
<p>The key is passing an object via the <code>enable</code> method. You can also set the <code>PostProcess.to</code> variable for the same effect. This connects the framebuffer from one <code>PostProcess</code> object to another. You&#39;ll also note that we only capture for the first shader. This is because we&#39;ve chained the framebuffers and only want to render to the first while using the output from that for our <code>PostProcess</code> objects.</p>

</div>


		<footer>
		<div class="ink-grid">
		   <div class="large-100 medium-100 small-100">
				Copyright &copy; 2011-2016 HaxePunk.com
				&bull;
				HaxePunk's <a href="https://github.com/HaxePunk">code</a> is licensed under
				<a href="http://opensource.org/licenses/MIT">MIT</a>
				&bull;
				Follow <a href="https://twitter.com/HaxePunk">@HaxePunk</a>
				&bull;
				<a href="https://github.com/HaxePunk/haxepunk.com">Site</a> made with <a href="http://ink.sapo.pt/">Ink</a>
				Powered by <a href="http://pages.github.com/">GitHub Pages</a>
			</div>
		</div>
		</footer>

		<script type="text/javascript" src="http://haxepunk.com/js/holder.js"></script>
		<script type="text/javascript" src="http://haxepunk.com/js/ink-all.min.js"></script>
		<script type="text/javascript" src="http://haxepunk.com/js/autoload.js"></script>
		<script type="text/javascript" src="http://haxepunk.com/js/html5shiv.js"></script>
	</body>

</html>
